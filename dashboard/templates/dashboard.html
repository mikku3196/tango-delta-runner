<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Chimera 監視ダッシュボード</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .status-card {
            transition: transform 0.2s;
        }
        .status-card:hover {
            transform: translateY(-2px);
        }
        .metric-value {
            font-size: 2rem;
            font-weight: bold;
        }
        .metric-label {
            font-size: 0.9rem;
            color: #6c757d;
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-running { background-color: #28a745; }
        .status-stopped { background-color: #dc3545; }
        .status-warning { background-color: #ffc107; }
        .chart-container {
            position: relative;
            height: 300px;
        }
        .refresh-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }
    </style>
</head>
<body class="bg-light">
    <nav class="navbar navbar-dark bg-dark">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">
                <i class="fas fa-chart-line"></i> Project Chimera 監視ダッシュボード
            </span>
            <span class="navbar-text" id="last-updated">
                最終更新: <span id="update-time">--:--:--</span>
            </span>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- システム状態 -->
        <div class="row mb-4">
            <div class="col-12">
                <h4><i class="fas fa-server"></i> システム状態</h4>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card status-card">
                    <div class="card-body text-center">
                        <div class="metric-value text-primary" id="cpu-usage">--%</div>
                        <div class="metric-label">CPU使用率</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card status-card">
                    <div class="card-body text-center">
                        <div class="metric-value text-info" id="memory-usage">--%</div>
                        <div class="metric-label">メモリ使用率</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card status-card">
                    <div class="card-body text-center">
                        <div class="metric-value text-warning" id="disk-usage">--%</div>
                        <div class="metric-label">ディスク使用率</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card status-card">
                    <div class="card-body text-center">
                        <div class="metric-value text-success" id="process-count">--</div>
                        <div class="metric-label">プロセス数</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bot状態 -->
        <div class="row mb-4">
            <div class="col-12">
                <h4><i class="fas fa-robot"></i> Bot状態</h4>
            </div>
            <div class="col-md-4 mb-3">
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-title">
                            <span class="status-indicator" id="index-bot-status"></span>
                            コア戦略Bot
                        </h6>
                        <p class="card-text">
                            <small class="text-muted">インデックス積立投資</small>
                        </p>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-title">
                            <span class="status-indicator" id="dividend-bot-status"></span>
                            高配当株Bot
                        </h6>
                        <p class="card-text">
                            <small class="text-muted">高配当株自動選定</small>
                        </p>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-title">
                            <span class="status-indicator" id="range-bot-status"></span>
                            レンジ取引Bot
                        </h6>
                        <p class="card-text">
                            <small class="text-muted">ボリンジャーバンド取引</small>
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ポートフォリオ状態 -->
        <div class="row mb-4">
            <div class="col-md-6 mb-3">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-pie"></i> ポートフォリオ構成</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="portfolio-chart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-6 mb-3">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-yen-sign"></i> NISA使用状況</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <div class="d-flex justify-content-between">
                                <span>年間枠</span>
                                <span id="annual-usage">--%</span>
                            </div>
                            <div class="progress">
                                <div class="progress-bar" id="annual-progress" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="d-flex justify-content-between">
                                <span>生涯枠</span>
                                <span id="lifetime-usage">--%</span>
                            </div>
                            <div class="progress">
                                <div class="progress-bar" id="lifetime-progress" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 取引状況 -->
        <div class="row mb-4">
            <div class="col-md-6 mb-3">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-exchange-alt"></i> 取引サマリー</h5>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-4">
                                <div class="metric-value text-success" id="total-trades">--</div>
                                <div class="metric-label">総取引数</div>
                            </div>
                            <div class="col-4">
                                <div class="metric-value text-primary" id="buy-trades">--</div>
                                <div class="metric-label">買い注文</div>
                            </div>
                            <div class="col-4">
                                <div class="metric-value text-danger" id="sell-trades">--</div>
                                <div class="metric-label">売り注文</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6 mb-3">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-line"></i> パフォーマンス</h5>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-4">
                                <div class="metric-value text-success" id="total-return">--%</div>
                                <div class="metric-label">総リターン</div>
                            </div>
                            <div class="col-4">
                                <div class="metric-value text-info" id="annual-return">--%</div>
                                <div class="metric-label">年率リターン</div>
                            </div>
                            <div class="col-4">
                                <div class="metric-value text-warning" id="max-drawdown">--%</div>
                                <div class="metric-label">最大DD</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ログ状況 -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-file-alt"></i> ログ状況</h5>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-3">
                                <div class="metric-value text-info" id="log-info">--</div>
                                <div class="metric-label">INFO</div>
                            </div>
                            <div class="col-3">
                                <div class="metric-value text-warning" id="log-warning">--</div>
                                <div class="metric-label">WARNING</div>
                            </div>
                            <div class="col-3">
                                <div class="metric-value text-danger" id="log-error">--</div>
                                <div class="metric-label">ERROR</div>
                            </div>
                            <div class="col-3">
                                <div class="metric-value text-dark" id="log-critical">--</div>
                                <div class="metric-label">CRITICAL</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 更新ボタン -->
    <button class="btn btn-primary refresh-btn" onclick="refreshData()">
        <i class="fas fa-sync-alt"></i>
    </button>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let portfolioChart = null;

        // データ更新
        async function refreshData() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                
                updateSystemStatus(data.system);
                updateLogStatus(data.logs);
                updateTradingStatus(data.trading);
                updatePortfolioStatus(data.portfolio);
                updateNisaStatus(data.nisa);
                updateBacktestStatus(data.backtest);
                
                document.getElementById('update-time').textContent = new Date().toLocaleTimeString();
            } catch (error) {
                console.error('データ更新エラー:', error);
            }
        }

        // システム状態更新
        function updateSystemStatus(system) {
            if (system.error) {
                console.error('システム状態エラー:', system.error);
                return;
            }
            
            document.getElementById('cpu-usage').textContent = system.system.cpu_percent.toFixed(1) + '%';
            document.getElementById('memory-usage').textContent = system.system.memory_percent.toFixed(1) + '%';
            document.getElementById('disk-usage').textContent = system.system.disk_percent.toFixed(1) + '%';
            document.getElementById('process-count').textContent = system.processes.length;
        }

        // ログ状態更新
        function updateLogStatus(logs) {
            if (logs.error) {
                console.error('ログ状態エラー:', logs.error);
                return;
            }
            
            document.getElementById('log-info').textContent = logs.level_counts.INFO || 0;
            document.getElementById('log-warning').textContent = logs.level_counts.WARNING || 0;
            document.getElementById('log-error').textContent = logs.level_counts.ERROR || 0;
            document.getElementById('log-critical').textContent = logs.level_counts.CRITICAL || 0;
        }

        // 取引状態更新
        function updateTradingStatus(trading) {
            if (trading.error) {
                console.error('取引状態エラー:', trading.error);
                return;
            }
            
            document.getElementById('total-trades').textContent = trading.total_trades || 0;
            document.getElementById('buy-trades').textContent = trading.buy_trades || 0;
            document.getElementById('sell-trades').textContent = trading.sell_trades || 0;
        }

        // ポートフォリオ状態更新
        function updatePortfolioStatus(portfolio) {
            if (portfolio.error) {
                console.error('ポートフォリオ状態エラー:', portfolio.error);
                return;
            }
            
            // ポートフォリオチャート更新
            if (portfolioChart) {
                portfolioChart.destroy();
            }
            
            const ctx = document.getElementById('portfolio-chart').getContext('2d');
            portfolioChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['インデックス', '高配当株', 'レンジ取引'],
                    datasets: [{
                        data: [
                            portfolio.current_values.index,
                            portfolio.current_values.dividend,
                            portfolio.current_values.range
                        ],
                        backgroundColor: ['#007bff', '#28a745', '#ffc107']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        // NISA状態更新
        function updateNisaStatus(nisa) {
            if (nisa.error) {
                console.error('NISA状態エラー:', nisa.error);
                return;
            }
            
            document.getElementById('annual-usage').textContent = nisa.annual_usage_percent.toFixed(1) + '%';
            document.getElementById('lifetime-usage').textContent = nisa.lifetime_usage_percent.toFixed(1) + '%';
            
            document.getElementById('annual-progress').style.width = nisa.annual_usage_percent + '%';
            document.getElementById('lifetime-progress').style.width = nisa.lifetime_usage_percent + '%';
            
            // プログレスバーの色を設定
            const annualProgress = document.getElementById('annual-progress');
            const lifetimeProgress = document.getElementById('lifetime-progress');
            
            if (nisa.annual_usage_percent > 90) {
                annualProgress.className = 'progress-bar bg-danger';
            } else if (nisa.annual_usage_percent > 75) {
                annualProgress.className = 'progress-bar bg-warning';
            } else {
                annualProgress.className = 'progress-bar bg-success';
            }
            
            if (nisa.lifetime_usage_percent > 90) {
                lifetimeProgress.className = 'progress-bar bg-danger';
            } else if (nisa.lifetime_usage_percent > 75) {
                lifetimeProgress.className = 'progress-bar bg-warning';
            } else {
                lifetimeProgress.className = 'progress-bar bg-success';
            }
        }

        // バックテスト状態更新
        function updateBacktestStatus(backtest) {
            if (backtest.error) {
                console.error('バックテスト状態エラー:', backtest.error);
                return;
            }
            
            document.getElementById('total-return').textContent = (backtest.total_return * 100).toFixed(2) + '%';
            document.getElementById('annual-return').textContent = (backtest.annual_return * 100).toFixed(2) + '%';
            document.getElementById('max-drawdown').textContent = (backtest.max_drawdown * 100).toFixed(2) + '%';
        }

        // 初期化
        document.addEventListener('DOMContentLoaded', function() {
            refreshData();
            setInterval(refreshData, 30000); // 30秒ごとに更新
        });
    </script>
</body>
</html>
